# Laravel Cloud 500 Error Troubleshooting Guide

## Common Causes & Solutions

### 1. **Missing Environment Variables**

**Symptom:** 500 error on first load

**Solution - Set these in Laravel Cloud environment:**

```env
APP_NAME="Email Verification Service"
APP_ENV=production
APP_DEBUG=false
APP_KEY=<auto-generated or provide one>
APP_URL=https://your-domain.laravel.cloud

# Database connection (Railway or other)
DB_CONNECTION=mysql
DB_HOST=<your-db-host>
DB_PORT=3306
DB_DATABASE=<your-db-name>
DB_USERNAME=<your-db-user>
DB_PASSWORD=<your-db-password>

# Session & Cache
SESSION_DRIVER=database
CACHE_STORE=database
QUEUE_CONNECTION=database

# Mail
MAIL_MAILER=log
MAIL_FROM_ADDRESS=noreply@your-domain.com

# Admin
ADMIN_EMAILS=your-email@example.com
```

### 2. **Database Not Migrated**

**Symptom:** "Target class does not exist" or database errors

**Solution - Check migrations:**

```bash
# Via Laravel Cloud CLI or SSH
laravel-cloud run "php artisan migrate:status"

# If migrations haven't run:
laravel-cloud run "php artisan migrate --force"
```

### 3. **Configuration Cache Issues**

**Symptom:** Config not loading, old values being used

**Solution:**

```bash
# Clear all caches
laravel-cloud run "php artisan cache:clear"
laravel-cloud run "php artisan config:cache"
laravel-cloud run "php artisan route:cache"
```

### 4. **Permission Issues**

**Symptom:** "Storage directory not writable"

**Solution - In your deployment:**

The Dockerfile already handles this, but if needed:

```bash
laravel-cloud run "chmod -R 775 storage bootstrap/cache"
```

### 5. **Missing Dependencies**

**Symptom:** "Class not found" errors

**Solution - Verify composer install:**

```bash
# Rebuild the container
laravel-cloud rebuild --no-cache
```

---

## Quick Debugging Steps

### Step 1: Check Logs

```bash
# View real-time logs
laravel-cloud logs

# Or check in Laravel Cloud dashboard under "Logs"
```

### Step 2: Access Container Shell

```bash
# SSH into the running container
laravel-cloud shell

# Once inside:
php artisan tinker
DB::connection()->getPdo(); # Test database connection
config('app.debug'); # Check if debug mode is on
```

### Step 3: Verify Database Connection

```bash
laravel-cloud run "php artisan tinker"
# Inside tinker:
>>> DB::connection()->getPdo()
>>> // Should return PDO object, not error
```

### Step 4: Check Application Health

```bash
laravel-cloud run "php artisan"
# Should display available commands
```

---

## Environment Variables Checklist

- [ ] `APP_KEY` is set (not empty)
- [ ] `APP_ENV=production` (not local)
- [ ] `APP_DEBUG=false` (never true in production)
- [ ] `DB_HOST` points to correct database
- [ ] `DB_USERNAME` and `DB_PASSWORD` are correct
- [ ] `DB_DATABASE` exists and is created
- [ ] `SESSION_DRIVER=database`
- [ ] `CACHE_STORE=database`
- [ ] `QUEUE_CONNECTION=database`

---

## Deployment Checklist

Before deploying to Laravel Cloud:

1. **Locally test:**
   ```bash
   composer install
   php artisan key:generate
   php artisan migrate
   php artisan serve
   # Visit http://localhost:8000
   ```

2. **Verify tests pass:**
   ```bash
   composer test
   vendor/bin/pint --test
   ```

3. **Push to Git:**
   ```bash
   git add .
   git commit -m "Fix: deployment configuration"
   git push origin main
   ```

4. **Configure Laravel Cloud Variables:**
   - Add all required environment variables
   - Ensure database is provisioned

5. **Deploy & Monitor:**
   - Deploy via Laravel Cloud dashboard
   - Watch logs for any errors
   - Test all major features

---

## Common HTTP 500 Errors

| Error Message | Cause | Solution |
|---|---|---|
| "SQLSTATE[HY000]" | Database not accessible | Check DB_HOST, DB_USER, DB_PASS |
| "Target class not found" | Not migrated | Run `php artisan migrate` |
| "Storage directory not writable" | Permissions | Already handled in Dockerfile |
| "Class not found" | Missing dependency | Run `composer install` |
| "Undefined variable" | Config not cached properly | Run `php artisan config:cache` |

---

## Production Best Practices

1. **Always set `APP_DEBUG=false`** in production
2. **Use strong `APP_KEY`** (generated with `php artisan key:generate`)
3. **Enable HTTPS** (Laravel Cloud provides SSL)
4. **Use strong database passwords**
5. **Monitor logs regularly** for errors
6. **Keep dependencies updated:** `composer update`
7. **Back up database** before major deployments

---

## If Still Getting 500 Error

1. **Check logs:** `laravel-cloud logs`
2. **SSH into container:** `laravel-cloud shell`
3. **Run diagnostics:**
   ```bash
   php artisan tinker
   config('database') # Check DB config
   DB::connection()->getPdo() # Test connection
   ```
4. **Manually run migrations:**
   ```bash
   php artisan migrate --force
   ```
5. **Clear caches:**
   ```bash
   php artisan cache:clear
   php artisan config:cache
   php artisan route:cache
   ```

---

## Contact & Resources

- Laravel Cloud Docs: https://laravel.com/docs/deployment
- This App's Deployment Guide: See `DEPLOYMENT.md`
- Laravel Health Checks: `php artisan tinker` then test connections
